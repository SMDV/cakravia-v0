name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_version:
        description: 'Deployment version (optional)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint
      continue-on-error: false

    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}

    - name: Generate deployment version
      id: version
      run: |
        if [ -n "${{ github.event.inputs.deployment_version }}" ]; then
          echo "version=${{ github.event.inputs.deployment_version }}" >> $GITHUB_OUTPUT
        else
          echo "version=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 25m
        command_timeout: 25m
        envs: NEXT_PUBLIC_GOOGLE_CLIENT_ID,DEPLOYMENT_VERSION,GITHUB_SHA,GITHUB_REF
        script: |
          set -e

          echo "ğŸš€ Starting Deployment"
          echo "Version: ${DEPLOYMENT_VERSION}"
          echo "Commit: ${GITHUB_SHA}"
          echo "Branch: ${GITHUB_REF}"

          # Check if application directory exists
          if [ ! -d "/opt/cakravia" ]; then
            echo "Creating application directory..."
            sudo mkdir -p /opt/cakravia
            sudo chown $USER:$USER /opt/cakravia
          fi

          # Navigate to application directory
          cd /opt/cakravia

          # Check if this is first deployment
          if [ ! -f "docker-compose.yml" ]; then
            echo "First deployment - cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .

            # Create environment file
            cat > .env << EOF
          NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
          NODE_ENV=production
          NEXT_TELEMETRY_DISABLED=1
          DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}
          DEPLOYMENT_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GITHUB_SHA=${GITHUB_SHA}
          EOF

            # Create nginx directories
            mkdir -p nginx/ssl nginx/logs

            # Start initial deployment
            echo "Starting initial deployment..."
            docker-compose up -d --build

            # Wait for initial deployment
            echo "Waiting for initial deployment to be ready..."
            sleep 60

            # Check initial deployment health
            for i in {1..10}; do
              if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "âœ… Initial deployment is healthy!"
                break
              else
                echo "Health check $i/10 failed, retrying in 10 seconds..."
                sleep 10
              fi
            done

            echo "âœ… First deployment completed successfully!"
          else
            echo "Updating existing repository..."
            git fetch origin
            git reset --hard origin/main

            # Update environment file
            cat > .env << EOF
          NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
          NODE_ENV=production
          NEXT_TELEMETRY_DISABLED=1
          DEPLOYMENT_VERSION=${DEPLOYMENT_VERSION}
          DEPLOYMENT_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GITHUB_SHA=${GITHUB_SHA}
          EOF

            # Stop existing containers
            echo "Stopping existing containers..."
            docker-compose down

            # Pull latest images
            echo "Pulling latest images..."
            docker-compose pull

            # Start new deployment
            echo "Starting new deployment..."
            docker-compose up -d --build
          fi

          # Post-deployment verification
          echo "ğŸ” Running post-deployment verification..."

          # Check container status
          echo "Container status:"
          docker-compose ps

          # Wait for application to be ready
          echo "Waiting for application to be ready..."
          sleep 30

          # Test main health endpoint
          echo "Testing health endpoint..."
          if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
            echo "âœ… Main health check passed"
          else
            echo "âŒ Main health check failed"
            docker-compose logs --tail=50
            exit 1
          fi

          # Test application homepage
          echo "Testing application homepage..."
          if curl -f -s http://localhost:8080/ > /dev/null 2>&1; then
            echo "âœ… Application homepage accessible"
          else
            echo "âŒ Application homepage failed"
            exit 1
          fi

          # Display deployment information
          echo ""
          echo "ğŸ‰ Deployment Summary:"
          echo "   Version: ${DEPLOYMENT_VERSION}"
          echo "   Commit: ${GITHUB_SHA}"
          echo "   Time: $(date)"
          echo "   URL: https://cakravia.com"
          echo ""

          echo "âœ… Deployment completed successfully!"
      env:
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
        DEPLOYMENT_VERSION: ${{ steps.version.outputs.version }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}

    - name: Health Check Verification
      if: success()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 5m
        script: |
          cd /opt/cakravia

          echo "ğŸ¥ Running final health verification..."

          # Wait for deployment to stabilize
          sleep 20

          # Final health check
          for i in {1..3}; do
            echo "Health check round $i/3..."

            if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
              echo "âœ… Health check $i passed"
            else
              echo "âŒ Health check $i failed"
              docker-compose logs --tail=50
              exit 1
            fi

            sleep 10
          done

          echo "âœ… Final health verification completed!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ Deployment to cakravia.com successful!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Commit: ${{ github.sha }}"
        else
          echo "âŒ Deployment failed!"
          exit 1
        fi

    - name: Show logs on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 5m
        script: |
          cd /opt/cakravia

          echo "ğŸ“‹ Container status:"
          docker-compose ps || true

          echo ""
          echo "ğŸ“‹ Recent application logs:"
          docker-compose logs --tail=100 || true